# Use the latest stable version of Semaphore 2.0 YML syntax:
version: v1.0

# Name your pipeline. In case you connect multiple pipelines with promotions,
# the name will help you differentiate between, for example, a CI build phase
# and delivery phases.
name: Semaphore Chromedriver Pipeline 

# An agent defines the environment in which your code runs.
# It is a combination of one of available machine types and operating
# system images.
# See https://docs.semaphoreci.com/article/20-machine-types
# and https://docs.semaphoreci.com/article/32-ubuntu-1804-image
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
    # Set environment variables that your project requires.
    # See https://docs.semaphoreci.com/article/66-environment-variables-and-secrets
    env_vars:
      - name: SEMAPHORE_THREAD_COUNT
        value: "1"
      - name: CHROMEDRIVER_VERSION
        value: "2.46"
      - name: CLIVER_NO_VERIFY # Cliver detects the PhantomJS version incorrectly in Debian Stretch; disables version checks
        value: "1"
      - name: RAILS_ENV
        value: "test"
      - name: CI
        value: "true"
      - name: HOME
        value: "/root"
      - name: WEBAPP_INTERNAL_HOSTNAME
        value: "web"
      - name: PGHOST
        value: "postgres"
      - name: REDIS_HOST
        value: "redis:6379"
      - name: ELASTICSEARCH_HOST
        value: "http://elasticsearch:9200/"
      - name: MEMCACHED_IP
        value: "memcached"
      - name: REDIS
        value: "1"
      - name: NO_INLINE
        value: "1"
      - name: MEMCACHED
        value: "1"
      - name: QUEUE
        value: "*"
      - name: BOOTSNAP
        value: "1" 
  containers:
    - name: postgres
      image: postgres:11.1-alpine

    - name: memcached
      image: memcached:1.4-alpine

    - name: redis
      image: redis:3.2-alpine

    - name: elasticsearch
      image: elasticsearch:5.6.16-alpine
      env_vars:
        - name: discovery.type
          value: "single-node"
        - name: bootstrap.memory_lock
          value: "true"
        - name: ES_JAVA_OPTS
          value: "-Xms512m -Xmx512m"
        - name: xpack.security.enabled
          value: "false"
blocks:
 - name: Install dependecies
    task:
      jobs:
      - name: Download chromdriver
        commands:
          - wget https://chromedriver.storage.googleapis.com/2.46/chromedriver_linux64.zip -O /root/.webdriver/chromedriver
          - chromedriver --v
          - /root/webdriver/chromedriver -v
